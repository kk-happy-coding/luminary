<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LUMINARY — API Explorer</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* ─── TOKENS ─── */
:root {
  --bg:       #04020e;
  --bg2:      #07041a;
  --bg3:      #0a061f;
  --accent:   #00e5ff;
  --violet:   #7000ff;
  --pink:     #ff00a8;
  --green:    #00ff88;
  --yellow:   #ffc800;
  --text:     #dce8ff;
  --muted:    rgba(220,232,255,0.45);
  --glass:    rgba(255,255,255,0.03);
  --gb:       rgba(255,255,255,0.07);
  --glow-c:   0 0 30px rgba(0,229,255,0.25), 0 0 80px rgba(0,229,255,0.08);
  --sidebar:  280px;
  --nav-h:    56px;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'Syne', sans-serif;
  background: var(--bg);
  color: var(--text);
}

/* ─── GRAIN OVERLAY ─── */
body::after {
  content: '';
  position: fixed; inset: 0;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
  background-size: 180px 180px;
  opacity: 0.025;
  pointer-events: none;
  z-index: 9000;
  mix-blend-mode: overlay;
}

/* ─── CURSOR ─── */
#cur, #cur-ring {
  position: fixed; border-radius: 50%;
  pointer-events: none; z-index: 9999;
  transform: translate(-50%, -50%);
}
#cur { width: 10px; height: 10px; background: var(--accent); mix-blend-mode: screen; transition: transform 0.15s; }
#cur-ring { width: 38px; height: 38px; border: 1px solid rgba(0,229,255,0.35); transition: width .3s, height .3s, border-color .3s; }

/* ─── NAV ─── */
#nav {
  position: fixed; top: 0; left: 0; right: 0;
  height: var(--nav-h); z-index: 200;
  display: flex; align-items: center; gap: 1rem;
  padding: 0 1.2rem;
  background: rgba(4,2,14,0.85);
  backdrop-filter: blur(24px);
  border-bottom: 1px solid var(--gb);
}
.nav-logo {
  font-size: 0.9rem; font-weight: 800;
  letter-spacing: 0.25em; color: var(--text);
  display: flex; align-items: center; gap: 0.5rem;
  text-decoration: none; flex-shrink: 0;
}
.logo-pip {
  width: 7px; height: 7px; background: var(--accent);
  border-radius: 50%; box-shadow: 0 0 8px var(--accent), 0 0 18px var(--accent);
  animation: pip 2s ease-in-out infinite;
}
@keyframes pip { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.6;transform:scale(.75)} }

.nav-sep { width: 1px; height: 24px; background: var(--gb); flex-shrink: 0; }
.nav-env-wrap { display: flex; align-items: center; gap: 0.5rem; flex: 1; min-width: 0; }
.env-select {
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem; letter-spacing: 0.08em;
  padding: 0.3rem 0.6rem; border-radius: 5px; cursor: pointer;
  max-width: 220px; min-width: 120px;
}
.env-select:focus { outline: none; border-color: rgba(0,229,255,0.4); }
.btn-icon {
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--muted); font-size: 0.9rem;
  padding: 0.28rem 0.55rem; border-radius: 5px; cursor: pointer;
  transition: color .2s, border-color .2s, background .2s;
  flex-shrink: 0;
}
.btn-icon:hover { color: var(--accent); border-color: rgba(0,229,255,0.35); background: rgba(0,229,255,0.05); }

.btn-nav {
  background: rgba(0,229,255,0.08); border: 1px solid rgba(0,229,255,0.25);
  color: var(--accent); font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.72rem; letter-spacing: 0.12em;
  padding: 0.32rem 0.9rem; border-radius: 5px; cursor: pointer;
  transition: background .2s, box-shadow .2s;
  flex-shrink: 0;
}
.btn-nav:hover { background: rgba(0,229,255,0.14); box-shadow: var(--glow-c); }

/* ─── SHELL ─── */
#shell {
  position: fixed;
  top: var(--nav-h); left: 0; right: 0; bottom: 0;
  display: grid;
  grid-template-columns: var(--sidebar) 1fr;
  grid-template-rows: 1fr;
}

/* ─── SIDEBAR ─── */
#sidebar {
  border-right: 1px solid var(--gb);
  display: flex; flex-direction: column;
  overflow: hidden; background: rgba(4,2,14,0.6);
}
.sidebar-search {
  padding: 0.7rem 0.8rem;
  border-bottom: 1px solid var(--gb);
  flex-shrink: 0;
}
.search-input {
  width: 100%;
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem; padding: 0.38rem 0.6rem; border-radius: 5px;
}
.search-input::placeholder { color: var(--muted); }
.search-input:focus { outline: none; border-color: rgba(0,229,255,0.3); }

.sidebar-ep-list {
  flex: 1; overflow-y: auto; overflow-x: hidden;
  padding: 0.4rem 0;
}
.sidebar-ep-list::-webkit-scrollbar { width: 4px; }
.sidebar-ep-list::-webkit-scrollbar-track { background: transparent; }
.sidebar-ep-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* Tag groups */
.tag-group { }
.tag-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.5rem 0.8rem 0.3rem;
  font-size: 0.65rem; font-weight: 700; letter-spacing: 0.18em;
  color: var(--muted); cursor: pointer;
  user-select: none;
  transition: color .2s;
}
.tag-header:hover { color: var(--text); }
.tag-chevron { font-size: 0.55rem; transition: transform .2s; }
.tag-group.collapsed .tag-chevron { transform: rotate(-90deg); }
.tag-group.collapsed .tag-endpoints { display: none; }

/* Endpoint rows */
.ep-row {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.3rem 0.8rem 0.3rem 1.2rem;
  cursor: pointer; transition: background .15s;
  border-left: 2px solid transparent;
}
.ep-row:hover { background: rgba(255,255,255,0.03); }
.ep-row.active {
  background: rgba(0,229,255,0.05);
  border-left-color: var(--accent);
}
.method-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem; font-weight: 500;
  letter-spacing: 0.06em;
  padding: 0.12rem 0.38rem; border-radius: 3px;
  flex-shrink: 0; min-width: 46px; text-align: center;
}
.m-get    { background: rgba(0,229,255,0.1);  color: var(--accent);  border: 1px solid rgba(0,229,255,0.2);  }
.m-post   { background: rgba(0,255,136,0.1);  color: var(--green);   border: 1px solid rgba(0,255,136,0.2);  }
.m-put    { background: rgba(255,200,0,0.1);  color: var(--yellow);  border: 1px solid rgba(255,200,0,0.2);  }
.m-patch  { background: rgba(112,0,255,0.1);  color: #a855f7;        border: 1px solid rgba(112,0,255,0.2);  }
.m-delete { background: rgba(255,0,168,0.1);  color: var(--pink);    border: 1px solid rgba(255,0,168,0.2);  }
.m-head   { background: rgba(100,100,200,0.1);color: #818cf8;        border: 1px solid rgba(100,100,200,0.2);}
.m-options{ background: rgba(100,100,200,0.08);color: #64748b;       border: 1px solid rgba(100,100,200,0.15);}
.ep-path {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem; color: var(--muted);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  transition: color .15s;
}
.ep-row:hover .ep-path, .ep-row.active .ep-path { color: var(--text); }

/* no-spec hero inside sidebar area */
#no-spec-state {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 10;
  pointer-events: none;
}

/* ─── MAIN PANEL ─── */
#main-panel {
  display: grid;
  grid-template-rows: 35% 30% 35%;
  overflow: hidden;
  position: relative;
}

/* Aurora hero (no-spec state) */
#aurora-wrap {
  position: absolute; inset: 0; z-index: 5;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  pointer-events: none;
  transition: opacity .5s;
}
#aurora-wrap.hidden { opacity: 0; pointer-events: none; }
#aurora { position: absolute; inset: 0; width: 100%; height: 100%; }
.hero-grid {
  position: absolute; inset: 0;
  background-image:
    linear-gradient(rgba(0,229,255,0.04) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0,229,255,0.04) 1px, transparent 1px);
  background-size: 64px 64px;
  mask-image: radial-gradient(ellipse 75% 75% at 50% 50%, black 10%, transparent 100%);
  -webkit-mask-image: radial-gradient(ellipse 75% 75% at 50% 50%, black 10%, transparent 100%);
}
.hero-vignette { position: absolute; inset: 0; background: radial-gradient(ellipse 100% 100% at 50% 50%, transparent 40%, var(--bg) 100%); }
.hero-cta {
  position: relative; z-index: 2;
  text-align: center; pointer-events: all;
  display: flex; flex-direction: column; align-items: center; gap: 1.2rem;
}
.hero-title-sm {
  font-size: clamp(2rem, 5vw, 4rem);
  font-weight: 800; letter-spacing: -0.02em;
}
.hero-title-sm .t1 {
  background: linear-gradient(135deg, #fff 0%, #c8e0ff 35%, var(--accent) 65%, var(--violet) 100%);
  -webkit-background-clip: text; background-clip: text;
  -webkit-text-fill-color: transparent;
}
.hero-sub-sm {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.82rem; color: var(--muted); letter-spacing: 0.04em;
}
.btn-hero {
  background: var(--accent); color: var(--bg);
  font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.82rem; letter-spacing: 0.12em;
  padding: 0.75rem 2rem; border-radius: 5px; border: none; cursor: pointer;
  transition: transform .25s, box-shadow .25s;
}
.btn-hero:hover { transform: translateY(-3px); box-shadow: var(--glow-c); }

/* Panel sections */
.panel-section {
  border-bottom: 1px solid var(--gb);
  display: flex; flex-direction: column;
  overflow: hidden;
  position: relative; z-index: 1;
}
.panel-section:last-child { border-bottom: none; }
.panel-header {
  display: flex; align-items: center; gap: 0.6rem;
  padding: 0.5rem 1rem;
  border-bottom: 1px solid var(--gb);
  flex-shrink: 0;
  background: rgba(4,2,14,0.4);
}
.panel-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; letter-spacing: 0.2em; color: var(--muted);
  font-weight: 500;
}
.panel-label.active-color { color: var(--accent); }
.panel-body { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0.8rem 1rem; }
.panel-body::-webkit-scrollbar { width: 4px; }
.panel-body::-webkit-scrollbar-track { background: transparent; }
.panel-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* ─── DOCS PANEL ─── */
.doc-title {
  font-size: 1.1rem; font-weight: 700; margin-bottom: 0.3rem;
  letter-spacing: -0.01em;
}
.doc-meta {
  display: flex; align-items: center; gap: 0.5rem;
  margin-bottom: 0.6rem; flex-wrap: wrap;
}
.doc-method { font-size: 0.8rem; font-weight: 700; }
.doc-path {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.78rem; color: var(--muted);
}
.doc-description {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.74rem; color: var(--muted); line-height: 1.7;
  margin-bottom: 0.8rem;
}
.param-table { width: 100%; border-collapse: collapse; }
.param-table th {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem; letter-spacing: 0.18em; color: var(--muted);
  text-align: left; padding: 0.25rem 0.5rem;
  border-bottom: 1px solid var(--gb);
  font-weight: 500;
}
.param-table td {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; padding: 0.28rem 0.5rem;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  color: var(--text);
}
.param-name { color: var(--accent); }
.param-in { color: var(--muted); font-size: 0.62rem; }
.param-req { color: var(--pink); font-size: 0.6rem; }

/* ─── REQUEST BUILDER ─── */
.req-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
.req-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; letter-spacing: 0.15em; color: var(--muted);
  min-width: 70px;
}
.req-input {
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem; padding: 0.3rem 0.5rem; border-radius: 4px;
  flex: 1;
}
.req-input:focus { outline: none; border-color: rgba(0,229,255,0.3); }
.kv-row { display: flex; gap: 0.4rem; margin-bottom: 0.35rem; align-items: center; }
.kv-input {
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; padding: 0.25rem 0.45rem; border-radius: 4px;
  flex: 1;
}
.kv-input:focus { outline: none; border-color: rgba(0,229,255,0.3); }
.kv-checkbox { accent-color: var(--accent); cursor: pointer; }
.btn-add {
  background: none; border: 1px dashed var(--gb);
  color: var(--muted); font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; letter-spacing: 0.1em;
  padding: 0.22rem 0.6rem; border-radius: 4px; cursor: pointer;
  transition: color .2s, border-color .2s;
  margin-bottom: 0.5rem;
}
.btn-add:hover { color: var(--accent); border-color: rgba(0,229,255,0.35); }
.btn-remove {
  background: none; border: none; color: var(--muted);
  font-size: 0.8rem; cursor: pointer; padding: 0; line-height: 1;
  transition: color .2s;
}
.btn-remove:hover { color: var(--pink); }
.body-textarea {
  width: 100%; min-height: 70px;
  background: rgba(0,0,0,0.3); border: 1px solid var(--gb);
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem; line-height: 1.6;
  padding: 0.5rem; border-radius: 5px; resize: vertical;
}
.body-textarea:focus { outline: none; border-color: rgba(0,229,255,0.3); }
.sec-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem; letter-spacing: 0.2em; color: var(--muted);
  margin: 0.6rem 0 0.35rem; font-weight: 500;
}
.btn-execute {
  background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
  border: none; color: var(--bg);
  font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.75rem; letter-spacing: 0.12em;
  padding: 0.45rem 1.4rem; border-radius: 5px; cursor: pointer;
  transition: transform .2s, box-shadow .2s;
  display: flex; align-items: center; gap: 0.4rem;
}
.btn-execute:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--glow-c); }
.btn-execute:disabled { opacity: 0.5; cursor: not-allowed; }
.spinner {
  width: 12px; height: 12px;
  border: 2px solid rgba(0,0,0,0.3);
  border-top-color: var(--bg);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  display: none;
}
.btn-execute.loading .spinner { display: block; }
@keyframes spin { to { transform: rotate(360deg); } }

/* ─── RESPONSE VIEWER ─── */
.resp-meta {
  display: flex; align-items: center; gap: 0.8rem;
  flex-wrap: wrap;
}
.status-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem; font-weight: 500;
  padding: 0.18rem 0.6rem; border-radius: 4px;
}
.s-2xx { background: rgba(0,255,136,0.12); color: var(--green); border: 1px solid rgba(0,255,136,0.25); }
.s-3xx { background: rgba(255,200,0,0.12); color: var(--yellow); border: 1px solid rgba(255,200,0,0.25); }
.s-4xx { background: rgba(255,100,0,0.12); color: #ff7b00; border: 1px solid rgba(255,100,0,0.25); }
.s-5xx { background: rgba(255,0,168,0.12); color: var(--pink); border: 1px solid rgba(255,0,168,0.25); }
.resp-time {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem; color: var(--muted);
}
.resp-url {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; color: var(--muted);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  max-width: 400px;
}
.resp-tabs { display: flex; gap: 0; margin-top: 0.6rem; }
.resp-tab {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; letter-spacing: 0.15em;
  padding: 0.25rem 0.7rem;
  background: none; border: 1px solid var(--gb);
  color: var(--muted); cursor: pointer;
  transition: color .2s, background .2s;
}
.resp-tab:first-child { border-radius: 4px 0 0 4px; }
.resp-tab:last-child  { border-radius: 0 4px 4px 0; border-left: none; }
.resp-tab.active { background: rgba(0,229,255,0.08); color: var(--accent); border-color: rgba(0,229,255,0.25); }
.resp-content { margin-top: 0.6rem; }
.resp-body-pre {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; line-height: 1.7;
  white-space: pre-wrap; word-break: break-all;
}
.hdr-table { width: 100%; border-collapse: collapse; }
.hdr-table th {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem; letter-spacing: 0.15em; color: var(--muted);
  text-align: left; padding: 0.2rem 0.4rem;
  border-bottom: 1px solid var(--gb); font-weight: 500;
}
.hdr-table td {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem; padding: 0.22rem 0.4rem;
  border-bottom: 1px solid rgba(255,255,255,0.04);
}
.hdr-key { color: var(--accent); }
.hdr-val { color: var(--muted); word-break: break-all; }
.resp-empty {
  display: flex; align-items: center; justify-content: center;
  height: 100%;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem; color: var(--muted); letter-spacing: 0.12em;
}

/* ─── JSON SYNTAX ─── */
.jk { color: #9d4edd; }
.jv-str { color: var(--green); }
.jv-num { color: var(--accent); }
.jv-bool { color: var(--yellow); }
.jv-null { color: var(--muted); }

/* ─── MODALS ─── */
.modal-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(4,2,14,0.8); backdrop-filter: blur(12px);
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity .3s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--bg2); border: 1px solid var(--gb);
  border-radius: 14px; padding: 1.6rem;
  width: min(520px, 92vw); max-height: 85vh;
  overflow-y: auto;
  transform: translateY(20px) scale(0.97);
  transition: transform .3s;
}
.modal-overlay.open .modal { transform: translateY(0) scale(1); }
.modal::-webkit-scrollbar { width: 4px; }
.modal::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
.modal-title {
  font-size: 1rem; font-weight: 800; letter-spacing: 0.12em;
  margin-bottom: 1.2rem; color: var(--text);
  display: flex; align-items: center; justify-content: space-between;
}
.modal-close {
  background: none; border: none; color: var(--muted);
  font-size: 1.2rem; cursor: pointer; line-height: 1;
  transition: color .2s;
}
.modal-close:hover { color: var(--pink); }
.form-group { margin-bottom: 0.9rem; }
.form-label {
  display: block;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; letter-spacing: 0.15em; color: var(--muted);
  margin-bottom: 0.3rem;
}
.form-input, .form-select {
  width: 100%;
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--text); font-family: 'JetBrains Mono', monospace;
  font-size: 0.74rem; padding: 0.42rem 0.7rem; border-radius: 5px;
}
.form-input:focus, .form-select:focus { outline: none; border-color: rgba(0,229,255,0.4); }
.form-select { cursor: pointer; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.7rem; }
.form-check { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem; }
.form-check input { accent-color: var(--accent); }
.form-check label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem; color: var(--muted); cursor: pointer;
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent), #0099cc);
  border: none; color: var(--bg);
  font-family: 'Syne', sans-serif; font-weight: 700;
  font-size: 0.78rem; letter-spacing: 0.1em;
  padding: 0.5rem 1.4rem; border-radius: 5px; cursor: pointer;
  transition: transform .2s, box-shadow .2s;
}
.btn-primary:hover { transform: translateY(-2px); box-shadow: var(--glow-c); }
.btn-secondary {
  background: var(--glass); border: 1px solid var(--gb);
  color: var(--muted); font-family: 'Syne', sans-serif;
  font-size: 0.78rem; letter-spacing: 0.1em;
  padding: 0.5rem 1.1rem; border-radius: 5px; cursor: pointer;
  transition: color .2s, border-color .2s;
}
.btn-secondary:hover { color: var(--text); border-color: rgba(255,255,255,0.15); }
.btn-danger {
  background: rgba(255,0,168,0.08); border: 1px solid rgba(255,0,168,0.2);
  color: var(--pink); font-family: 'Syne', sans-serif;
  font-size: 0.72rem; letter-spacing: 0.08em;
  padding: 0.3rem 0.7rem; border-radius: 4px; cursor: pointer;
  transition: background .2s;
}
.btn-danger:hover { background: rgba(255,0,168,0.16); }
.modal-footer { display: flex; gap: 0.7rem; justify-content: flex-end; margin-top: 1.2rem; }
.preset-btn {
  background: rgba(112,0,255,0.08); border: 1px solid rgba(112,0,255,0.25);
  color: #a855f7; font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem; letter-spacing: 0.08em;
  padding: 0.28rem 0.7rem; border-radius: 4px; cursor: pointer;
  transition: background .2s;
}
.preset-btn:hover { background: rgba(112,0,255,0.16); }

/* Env list in modal */
.env-list-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.6rem 0.8rem;
  background: var(--glass); border: 1px solid var(--gb);
  border-radius: 7px; margin-bottom: 0.5rem;
}
.env-list-info { flex: 1; min-width: 0; }
.env-list-name {
  font-size: 0.82rem; font-weight: 700; margin-bottom: 0.15rem;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.env-list-url {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.62rem; color: var(--muted);
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.env-list-actions { display: flex; gap: 0.4rem; flex-shrink: 0; margin-left: 0.8rem; }
.env-list-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.58rem; letter-spacing: 0.08em;
  padding: 0.1rem 0.4rem; border-radius: 3px;
  background: rgba(0,229,255,0.08); color: var(--accent);
  border: 1px solid rgba(0,229,255,0.15);
}

.divider { height: 1px; background: var(--gb); margin: 1rem 0; }
.error-msg {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; color: var(--pink);
  padding: 0.4rem 0.6rem;
  background: rgba(255,0,168,0.06); border: 1px solid rgba(255,0,168,0.18);
  border-radius: 5px; margin-top: 0.5rem;
}
.success-msg {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.68rem; color: var(--green);
  padding: 0.4rem 0.6rem;
  background: rgba(0,255,136,0.06); border: 1px solid rgba(0,255,136,0.18);
  border-radius: 5px; margin-top: 0.5rem;
}
</style>
</head>
<body>

<div id="cur"></div>
<div id="cur-ring"></div>

<!-- ═══════════════════════════ NAV ═══════════════════════════ -->
<nav id="nav">
  <a class="nav-logo" href="#">
    <div class="logo-pip"></div>LUMINARY
  </a>
  <div class="nav-sep"></div>
  <div class="nav-env-wrap">
    <select class="env-select" id="envSelect" onchange="STATE.activeEnvId=this.value">
      <option value="">— no environment —</option>
    </select>
    <button class="btn-icon" title="Manage Environments" onclick="openEnvModal()">⚙</button>
  </div>
  <button class="btn-nav" onclick="openSpecModal()">LOAD SPEC</button>
</nav>

<!-- ═══════════════════════════ SHELL ═══════════════════════════ -->
<div id="shell">

  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-search">
      <input class="search-input" id="searchInput" placeholder="Search endpoints…"
             oninput="filterEndpoints(this.value)">
    </div>
    <div class="sidebar-ep-list" id="epList">
      <!-- populated by JS -->
    </div>
  </aside>

  <!-- MAIN PANEL -->
  <div id="main-panel">

    <!-- Aurora hero (hidden once spec loaded) -->
    <div id="aurora-wrap">
      <canvas id="aurora"></canvas>
      <div class="hero-grid"></div>
      <div class="hero-vignette"></div>
      <div class="hero-cta">
        <div class="hero-title-sm"><span class="t1">API EXPLORER</span></div>
        <p class="hero-sub-sm">Load an OpenAPI spec to begin exploring.</p>
        <button class="btn-hero" onclick="openSpecModal()">LOAD SPEC</button>
      </div>
    </div>

    <!-- DOCS panel -->
    <div class="panel-section" id="docsPanel">
      <div class="panel-header">
        <span class="panel-label" id="docsPanelLabel">DOCUMENTATION</span>
      </div>
      <div class="panel-body" id="docsBody">
        <div class="resp-empty">Select an endpoint to view documentation.</div>
      </div>
    </div>

    <!-- REQUEST BUILDER panel -->
    <div class="panel-section" id="reqPanel">
      <div class="panel-header">
        <span class="panel-label">REQUEST BUILDER</span>
        <div style="flex:1"></div>
        <button class="btn-execute" id="execBtn" onclick="executeRequest()" disabled>
          <div class="spinner" id="execSpinner"></div>
          EXECUTE
        </button>
      </div>
      <div class="panel-body" id="reqBody">
        <div class="resp-empty">Select an endpoint to build a request.</div>
      </div>
    </div>

    <!-- RESPONSE VIEWER panel -->
    <div class="panel-section" id="respPanel">
      <div class="panel-header">
        <span class="panel-label">RESPONSE</span>
        <div style="flex:1"></div>
        <div id="respMeta" class="resp-meta"></div>
      </div>
      <div class="panel-body" id="respBody">
        <div class="resp-empty">Execute a request to see the response.</div>
      </div>
    </div>

  </div><!-- /#main-panel -->
</div><!-- /#shell -->

<!-- ═══════════════════════════ SPEC MODAL ═══════════════════════════ -->
<div class="modal-overlay" id="specModal">
  <div class="modal">
    <div class="modal-title">
      LOAD SPEC
      <button class="modal-close" onclick="closeSpecModal()">✕</button>
    </div>

    <div class="form-group">
      <label class="form-label">SPEC URL (OpenAPI 3.x / Swagger 2.0, JSON or YAML)</label>
      <input class="form-input" id="specUrl" placeholder="https://…/openapi.yaml">
      <div style="margin-top:.4rem;display:flex;gap:.4rem;flex-wrap:wrap">
        <button class="preset-btn" onclick="setSpecPreset('morpheus')">HPE Morpheus (GitHub)</button>
        <button class="preset-btn" onclick="setSpecPreset('petstore')">Petstore (JSON)</button>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">AUTHENTICATE WITH ENVIRONMENT (optional)</label>
      <select class="form-select" id="specEnvSelect">
        <option value="">— none —</option>
      </select>
    </div>

    <div id="specMsg"></div>

    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeSpecModal()">CANCEL</button>
      <button class="btn-primary" onclick="fetchSpec()">FETCH</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════ ENV MODAL ═══════════════════════════ -->
<div class="modal-overlay" id="envModal">
  <div class="modal">
    <div class="modal-title">
      ENVIRONMENTS
      <button class="modal-close" onclick="closeEnvModal()">✕</button>
    </div>

    <div id="envListContainer"></div>
    <div class="divider"></div>

    <div style="margin-bottom:.6rem;font-family:'JetBrains Mono',monospace;font-size:.68rem;color:var(--accent);letter-spacing:.15em"
         id="envFormTitle">ADD ENVIRONMENT</div>

    <div class="form-group">
      <label class="form-label">NAME</label>
      <input class="form-input" id="envName" placeholder="Production">
    </div>
    <div class="form-group">
      <label class="form-label">BASE URL</label>
      <input class="form-input" id="envBaseUrl" placeholder="https://morpheus.example.com">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label class="form-label">AUTH TYPE</label>
        <select class="form-select" id="envAuthType" onchange="updateAuthFields()">
          <option value="none">None</option>
          <option value="bearer">Bearer Token</option>
          <option value="api_key">API Key</option>
          <option value="basic">Basic Auth</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">BEARER PREFIX</label>
        <input class="form-input" id="envBearerPrefix" value="Bearer" placeholder="Bearer">
      </div>
    </div>

    <div id="envAuthFields"></div>

    <div class="form-check">
      <input type="checkbox" id="envVerifySsl" checked>
      <label for="envVerifySsl">Verify SSL</label>
    </div>

    <div id="envMsg"></div>

    <div class="modal-footer">
      <button class="btn-secondary" id="envCancelBtn" onclick="resetEnvForm()">CLEAR</button>
      <button class="btn-primary" id="envSaveBtn" onclick="saveEnvironment()">SAVE</button>
    </div>
  </div>
</div>

<script>
/* ══════════════════════════════════════════
   AURORA CANVAS
══════════════════════════════════════════ */
(function () {
  const cv = document.getElementById('aurora');
  const cx = cv.getContext('2d');
  let W, H, mx = 0.5, my = 0.35;

  function resize() {
    const wrap = document.getElementById('aurora-wrap');
    W = cv.width = wrap.offsetWidth;
    H = cv.height = wrap.offsetHeight;
  }
  window.addEventListener('resize', resize); resize();

  document.addEventListener('mousemove', e => {
    mx += (e.clientX / innerWidth  - mx) * 0.04;
    my += (e.clientY / innerHeight - my) * 0.04;
  });

  const ORBS = [
    { bx:.2,  by:.3,  sz:.46, c:[112,0,255],   sp:.00055, ph:0   },
    { bx:.82, by:.18, sz:.40, c:[0,229,255],   sp:.00038, ph:1.4 },
    { bx:.5,  by:.75, sz:.55, c:[30,0,200],    sp:.00048, ph:3.1 },
    { bx:.12, by:.82, sz:.32, c:[0,190,230],   sp:.00065, ph:4.6 },
    { bx:.88, by:.6,  sz:.42, c:[160,70,240],  sp:.00042, ph:2.0 },
    { bx:.5,  by:.08, sz:.28, c:[255,0,168],   sp:.00070, ph:5.3 },
  ];

  function drawOrb(o, t) {
    const amp = Math.min(W, H) * 0.17;
    const x = (o.bx + mx * 0.07) * W + Math.sin(t * o.sp + o.ph)       * amp;
    const y = (o.by + my * 0.07) * H + Math.cos(t * o.sp * 0.68 + o.ph) * amp * 0.75;
    const r = o.sz * Math.min(W, H);
    const g = cx.createRadialGradient(x, y, 0, x, y, r);
    const [R, G, B] = o.c;
    g.addColorStop(0,    `rgba(${R},${G},${B},0.24)`);
    g.addColorStop(0.45, `rgba(${R},${G},${B},0.08)`);
    g.addColorStop(1,    `rgba(${R},${G},${B},0)`);
    cx.save(); cx.globalCompositeOperation = 'screen';
    cx.fillStyle = g;
    cx.beginPath(); cx.arc(x, y, r, 0, Math.PI * 2); cx.fill();
    cx.restore();
  }

  function frame(t) {
    cx.fillStyle = '#04020e'; cx.fillRect(0, 0, W, H);
    for (const o of ORBS) drawOrb(o, t);
    requestAnimationFrame(frame);
  }
  requestAnimationFrame(frame);
})();

/* ══════════════════════════════════════════
   CUSTOM CURSOR
══════════════════════════════════════════ */
(function () {
  const dot  = document.getElementById('cur');
  const ring = document.getElementById('cur-ring');
  let rx = innerWidth/2, ry = innerHeight/2;

  document.addEventListener('mousemove', e => {
    dot.style.left = e.clientX + 'px'; dot.style.top = e.clientY + 'px';
  });
  (function loop() {
    rx += (parseFloat(dot.style.left||0) - rx) * 0.11;
    ry += (parseFloat(dot.style.top ||0) - ry) * 0.11;
    ring.style.left = rx + 'px'; ring.style.top = ry + 'px';
    requestAnimationFrame(loop);
  })();

  document.addEventListener('mouseover', e => {
    if (e.target.matches('a,button,select,input,textarea,.ep-row,.tag-header')) {
      dot.style.transform  = 'translate(-50%,-50%) scale(2.8)';
      ring.style.width     = '54px'; ring.style.height = '54px';
      ring.style.borderColor = 'rgba(0,229,255,0.6)';
    }
  });
  document.addEventListener('mouseout', e => {
    if (e.target.matches('a,button,select,input,textarea,.ep-row,.tag-header')) {
      dot.style.transform  = 'translate(-50%,-50%) scale(1)';
      ring.style.width     = '38px'; ring.style.height = '38px';
      ring.style.borderColor = 'rgba(0,229,255,0.35)';
    }
  });
})();

/* ══════════════════════════════════════════
   STATE
══════════════════════════════════════════ */
const STATE = {
  environments: [],
  activeEnvId: null,
  spec: null,
  specFilter: '',
  activeEndpoint: null,
  pathParams: {},
  queryParams: [],     // [{key, value, enabled}]
  requestBody: '',
  extraHeaders: [],    // [{key, value, enabled}]
  response: null,
  requestInFlight: false,
  editingEnvId: null,
};

/* ══════════════════════════════════════════
   JSON FORMATTER
══════════════════════════════════════════ */
function jfmt(obj) {
  const str = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
  return str.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
    if (/^"/.test(match)) {
      if (/:$/.test(match)) return `<span class="jk">${match}</span>`;
      return `<span class="jv-str">${match}</span>`;
    }
    if (/true|false/.test(match)) return `<span class="jv-bool">${match}</span>`;
    if (/null/.test(match))       return `<span class="jv-null">${match}</span>`;
    return `<span class="jv-num">${match}</span>`;
  });
}

/* ══════════════════════════════════════════
   METHOD BADGE CLASS
══════════════════════════════════════════ */
function methodClass(m) {
  const map = { GET:'m-get', POST:'m-post', PUT:'m-put', PATCH:'m-patch', DELETE:'m-delete', HEAD:'m-head', OPTIONS:'m-options' };
  return map[m.toUpperCase()] || 'm-get';
}
function statusClass(code) {
  if (code >= 500) return 's-5xx';
  if (code >= 400) return 's-4xx';
  if (code >= 300) return 's-3xx';
  return 's-2xx';
}

/* ══════════════════════════════════════════
   ENVIRONMENT API
══════════════════════════════════════════ */
async function loadEnvironments() {
  const resp = await fetch('/api/environments');
  STATE.environments = await resp.json();
  renderEnvSelect();
  renderEnvList();
}

function renderEnvSelect() {
  const sel = document.getElementById('envSelect');
  const specSel = document.getElementById('specEnvSelect');
  const cur = STATE.activeEnvId;
  const opts = STATE.environments.map(e =>
    `<option value="${e.id}" ${e.id===cur?'selected':''}>${esc(e.name)}</option>`
  ).join('');
  sel.innerHTML = '<option value="">— no environment —</option>' + opts;
  specSel.innerHTML = '<option value="">— none —</option>' + opts;
  if (cur) sel.value = cur;
}

function renderEnvList() {
  const container = document.getElementById('envListContainer');
  if (!STATE.environments.length) {
    container.innerHTML = '<div class="resp-empty" style="height:auto;padding:.8rem 0;justify-content:start">No environments yet. Add one below.</div>';
    return;
  }
  container.innerHTML = STATE.environments.map(e => `
    <div class="env-list-item">
      <div class="env-list-info">
        <div class="env-list-name">${esc(e.name)}</div>
        <div class="env-list-url">${esc(e.base_url)}</div>
      </div>
      <div class="env-list-actions">
        <span class="env-list-badge">${esc(e.auth.type)}</span>
        <button class="btn-icon" onclick="editEnv('${e.id}')">✎</button>
        <button class="btn-danger" onclick="deleteEnv('${e.id}')">✕</button>
      </div>
    </div>
  `).join('');
}

function updateAuthFields() {
  const type = document.getElementById('envAuthType').value;
  const container = document.getElementById('envAuthFields');
  if (type === 'bearer') {
    container.innerHTML = `
      <div class="form-group"><label class="form-label">TOKEN</label>
        <input class="form-input" id="envToken" placeholder="your-token-here" type="password"></div>`;
  } else if (type === 'api_key') {
    container.innerHTML = `
      <div class="form-row">
        <div class="form-group"><label class="form-label">API KEY</label>
          <input class="form-input" id="envToken" placeholder="key-value" type="password"></div>
        <div class="form-group"><label class="form-label">HEADER NAME</label>
          <input class="form-input" id="envHeaderName" placeholder="X-API-Key"></div>
      </div>`;
  } else if (type === 'basic') {
    container.innerHTML = `
      <div class="form-row">
        <div class="form-group"><label class="form-label">USERNAME</label>
          <input class="form-input" id="envUsername" placeholder="admin"></div>
        <div class="form-group"><label class="form-label">PASSWORD</label>
          <input class="form-input" id="envPassword" placeholder="password" type="password"></div>
      </div>`;
  } else {
    container.innerHTML = '';
  }
}

function editEnv(id) {
  const env = STATE.environments.find(e => e.id === id);
  if (!env) return;
  STATE.editingEnvId = id;
  document.getElementById('envFormTitle').textContent = 'EDIT ENVIRONMENT';
  document.getElementById('envName').value = env.name;
  document.getElementById('envBaseUrl').value = env.base_url;
  document.getElementById('envAuthType').value = env.auth.type;
  document.getElementById('envBearerPrefix').value = env.auth.bearer_prefix || 'Bearer';
  document.getElementById('envVerifySsl').checked = env.verify_ssl;
  updateAuthFields();
  if (env.auth.type === 'bearer' && env.auth.has_token) {
    document.getElementById('envToken') && (document.getElementById('envToken').placeholder = '(token set — enter new to update)');
  }
  if (env.auth.type === 'api_key') {
    if (document.getElementById('envHeaderName')) document.getElementById('envHeaderName').value = env.auth.header_name || '';
    if (env.auth.has_token && document.getElementById('envToken')) document.getElementById('envToken').placeholder = '(key set)';
  }
  if (env.auth.type === 'basic') {
    if (document.getElementById('envUsername')) document.getElementById('envUsername').value = env.auth.username || '';
  }
  document.getElementById('envSaveBtn').textContent = 'UPDATE';
  document.getElementById('envCancelBtn').textContent = 'CANCEL EDIT';
}

async function deleteEnv(id) {
  if (!confirm('Delete this environment?')) return;
  await fetch(`/api/environments/${id}`, { method: 'DELETE' });
  if (STATE.activeEnvId === id) { STATE.activeEnvId = null; }
  if (STATE.editingEnvId === id) resetEnvForm();
  await loadEnvironments();
}

function resetEnvForm() {
  STATE.editingEnvId = null;
  document.getElementById('envFormTitle').textContent = 'ADD ENVIRONMENT';
  document.getElementById('envName').value = '';
  document.getElementById('envBaseUrl').value = '';
  document.getElementById('envAuthType').value = 'none';
  document.getElementById('envBearerPrefix').value = 'Bearer';
  document.getElementById('envVerifySsl').checked = true;
  document.getElementById('envAuthFields').innerHTML = '';
  document.getElementById('envMsg').innerHTML = '';
  document.getElementById('envSaveBtn').textContent = 'SAVE';
  document.getElementById('envCancelBtn').textContent = 'CLEAR';
}

async function saveEnvironment() {
  const name = document.getElementById('envName').value.trim();
  const baseUrl = document.getElementById('envBaseUrl').value.trim();
  const authType = document.getElementById('envAuthType').value;
  const bearerPrefix = document.getElementById('envBearerPrefix').value.trim() || 'Bearer';
  const verifySsl = document.getElementById('envVerifySsl').checked;

  if (!name || !baseUrl) {
    showMsg('envMsg', 'Name and Base URL are required.', 'error');
    return;
  }

  const auth = { type: authType, bearer_prefix: bearerPrefix };
  if (authType === 'bearer') {
    const tok = document.getElementById('envToken')?.value;
    if (tok) auth.token = tok;
  } else if (authType === 'api_key') {
    const tok = document.getElementById('envToken')?.value;
    if (tok) auth.token = tok;
    auth.header_name = document.getElementById('envHeaderName')?.value || null;
  } else if (authType === 'basic') {
    auth.username = document.getElementById('envUsername')?.value || null;
    auth.password = document.getElementById('envPassword')?.value || null;
  }

  const payload = { name, base_url: baseUrl, auth, verify_ssl: verifySsl };

  let resp;
  if (STATE.editingEnvId) {
    resp = await fetch(`/api/environments/${STATE.editingEnvId}`, {
      method: 'PUT', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
  } else {
    resp = await fetch('/api/environments', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
  }

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    showMsg('envMsg', err.detail || 'Failed to save environment.', 'error');
    return;
  }

  const saved = await resp.json();
  STATE.activeEnvId = saved.id;
  resetEnvForm();
  await loadEnvironments();
  showMsg('envMsg', 'Saved!', 'success');
}

/* ══════════════════════════════════════════
   SPEC API
══════════════════════════════════════════ */
const SPEC_PRESETS = {
  morpheus: 'https://raw.githubusercontent.com/HewlettPackard/morpheus-openapi/dev-8.1/openapi.yaml',
  petstore: 'https://petstore3.swagger.io/api/v3/openapi.json',
};

function setSpecPreset(key) {
  document.getElementById('specUrl').value = SPEC_PRESETS[key] || '';
}

async function fetchSpec() {
  const url = document.getElementById('specUrl').value.trim();
  if (!url) { showMsg('specMsg', 'URL is required.', 'error'); return; }

  const envId = document.getElementById('specEnvSelect').value || null;
  showMsg('specMsg', '⟳ Fetching…', 'success');

  const resp = await fetch('/api/spec/load', {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ url, environment_id: envId }),
  });

  if (!resp.ok) {
    const err = await resp.json().catch(() => ({}));
    showMsg('specMsg', err.detail || 'Failed to load spec.', 'error');
    return;
  }

  STATE.spec = await resp.json();
  closeSpecModal();
  renderSpec();
}

async function loadExistingSpec() {
  const resp = await fetch('/api/spec');
  const data = await resp.json();
  if (data && data.title) {
    STATE.spec = data;
    renderSpec();
  }
}

function renderSpec() {
  if (!STATE.spec) return;
  document.getElementById('aurora-wrap').classList.add('hidden');
  renderSidebar();
}

/* ══════════════════════════════════════════
   SIDEBAR / ENDPOINT LIST
══════════════════════════════════════════ */
function filterEndpoints(q) {
  STATE.specFilter = q.toLowerCase();
  renderSidebar();
}

function renderSidebar() {
  const list = document.getElementById('epList');
  if (!STATE.spec) { list.innerHTML = ''; return; }

  const endpoints = STATE.spec.endpoints || [];
  const q = STATE.specFilter;

  // Filter
  const filtered = q
    ? endpoints.filter(e =>
        e.path.toLowerCase().includes(q) ||
        (e.summary && e.summary.toLowerCase().includes(q)) ||
        (e.operation_id && e.operation_id.toLowerCase().includes(q)) ||
        e.method.toLowerCase().includes(q)
      )
    : endpoints;

  // Group by first tag
  const groups = {};
  const untagged = [];
  for (const ep of filtered) {
    const tag = ep.tags && ep.tags.length ? ep.tags[0] : null;
    if (tag) {
      (groups[tag] = groups[tag] || []).push(ep);
    } else {
      untagged.push(ep);
    }
  }

  let html = '';

  const renderGroup = (name, eps) => {
    const gid = 'tg-' + name.replace(/\W/g, '-');
    html += `<div class="tag-group" id="${gid}">
      <div class="tag-header" onclick="toggleGroup('${gid}')">
        <span>${esc(name.toUpperCase())}</span>
        <span class="tag-chevron">▾</span>
      </div>
      <div class="tag-endpoints">`;
    for (const ep of eps) html += renderEpRow(ep);
    html += `</div></div>`;
  };

  for (const [tag, eps] of Object.entries(groups).sort((a,b) => a[0].localeCompare(b[0]))) {
    renderGroup(tag, eps);
  }
  if (untagged.length) renderGroup('Other', untagged);

  list.innerHTML = html;

  // Mark active
  if (STATE.activeEndpoint) markActive(STATE.activeEndpoint.method, STATE.activeEndpoint.path);
}

function renderEpRow(ep) {
  const mc = methodClass(ep.method);
  const active = STATE.activeEndpoint &&
    STATE.activeEndpoint.method === ep.method && STATE.activeEndpoint.path === ep.path;
  return `<div class="ep-row ${active?'active':''}"
    onclick='selectEndpoint(${JSON.stringify(ep.method)}, ${JSON.stringify(ep.path)})'>
    <span class="method-badge ${mc}">${esc(ep.method)}</span>
    <span class="ep-path" title="${esc(ep.path)}">${esc(ep.path)}</span>
  </div>`;
}

function toggleGroup(gid) {
  document.getElementById(gid)?.classList.toggle('collapsed');
}

function markActive(method, path) {
  document.querySelectorAll('.ep-row').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.ep-row').forEach(el => {
    const badge = el.querySelector('.method-badge');
    const pathEl = el.querySelector('.ep-path');
    if (badge && pathEl && badge.textContent === method && pathEl.getAttribute('title') === path) {
      el.classList.add('active');
    }
  });
}

/* ══════════════════════════════════════════
   ENDPOINT SELECTION
══════════════════════════════════════════ */
function selectEndpoint(method, path) {
  const ep = STATE.spec.endpoints.find(e => e.method === method && e.path === path);
  if (!ep) return;
  STATE.activeEndpoint = ep;
  STATE.pathParams = {};
  STATE.queryParams = [];
  STATE.requestBody = '';
  STATE.response = null;

  // Auto-populate path params
  for (const p of ep.parameters) {
    if (p.location === 'path') STATE.pathParams[p.name] = '';
    if (p.location === 'query') {
      STATE.queryParams.push({ key: p.name, value: '', enabled: true });
    }
  }

  // Auto-fill body from schema
  if (ep.has_request_body && ep.request_body_schema) {
    STATE.requestBody = generateBodyFromSchema(ep.request_body_schema);
  }

  markActive(method, path);
  renderDocsPanel(ep);
  renderRequestBuilder(ep);
  renderResponseEmpty();
  document.getElementById('execBtn').disabled = false;
}

function generateBodyFromSchema(schema) {
  if (!schema || typeof schema !== 'object') return '{}';
  if (schema.example) return JSON.stringify(schema.example, null, 2);
  const props = schema.properties || {};
  const example = {};
  for (const [k, v] of Object.entries(props)) {
    if (v.example !== undefined) example[k] = v.example;
    else if (v.type === 'string')  example[k] = '';
    else if (v.type === 'integer' || v.type === 'number') example[k] = 0;
    else if (v.type === 'boolean') example[k] = false;
    else if (v.type === 'array')   example[k] = [];
    else if (v.type === 'object')  example[k] = {};
    else example[k] = null;
  }
  return JSON.stringify(example, null, 2);
}

/* ══════════════════════════════════════════
   DOCS PANEL
══════════════════════════════════════════ */
function renderDocsPanel(ep) {
  const mc = methodClass(ep.method);
  const label = document.getElementById('docsPanelLabel');
  label.className = 'panel-label active-color';
  label.textContent = 'DOCUMENTATION';

  let html = `
    <div class="doc-title">${esc(ep.summary || ep.operation_id || ep.path)}</div>
    <div class="doc-meta">
      <span class="method-badge ${mc} doc-method">${esc(ep.method)}</span>
      <code class="doc-path">${esc(ep.path)}</code>
    </div>`;

  if (ep.description) {
    html += `<div class="doc-description">${esc(ep.description)}</div>`;
  }

  if (ep.parameters && ep.parameters.length) {
    html += `<div class="sec-title">PARAMETERS</div>
      <table class="param-table">
        <thead><tr><th>NAME</th><th>IN</th><th>REQUIRED</th><th>TYPE</th><th>DESCRIPTION</th></tr></thead>
        <tbody>`;
    for (const p of ep.parameters) {
      const type = p.schema_ && p.schema_.type ? p.schema_.type : '—';
      html += `<tr>
        <td class="param-name">${esc(p.name)}</td>
        <td class="param-in">${esc(p.location)}</td>
        <td class="param-req">${p.required ? 'yes' : ''}</td>
        <td class="param-in">${esc(type)}</td>
        <td style="color:var(--muted);font-size:.62rem">${esc(p.description||'')}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  if (ep.has_request_body) {
    html += `<div class="sec-title">REQUEST BODY ${ep.request_body_required ? '<span style="color:var(--pink)">*required</span>' : ''}</div>`;
    if (ep.request_body_schema) {
      html += `<pre class="resp-body-pre" style="max-height:120px;overflow:auto">${jfmt(ep.request_body_schema)}</pre>`;
    }
  }

  document.getElementById('docsBody').innerHTML = html;
}

/* ══════════════════════════════════════════
   REQUEST BUILDER
══════════════════════════════════════════ */
function renderRequestBuilder(ep) {
  const pathParams = ep.parameters.filter(p => p.location === 'path');
  let html = '';

  if (pathParams.length) {
    html += `<div class="sec-title">PATH PARAMETERS</div>`;
    for (const p of pathParams) {
      html += `<div class="req-row">
        <span class="req-label">{${esc(p.name)}}</span>
        <input class="req-input" placeholder="${esc(p.name)}"
               value="${esc(STATE.pathParams[p.name]||'')}"
               oninput="STATE.pathParams['${esc(p.name)}']=this.value">
      </div>`;
    }
  }

  html += `<div class="sec-title">QUERY PARAMETERS</div>`;
  html += `<div id="queryParamsContainer">`;
  for (let i = 0; i < STATE.queryParams.length; i++) {
    html += renderKvRow('query', i);
  }
  html += `</div>`;
  html += `<button class="btn-add" onclick="addKvRow('query')">+ ADD QUERY PARAM</button>`;

  html += `<div class="sec-title">HEADERS</div>`;
  html += `<div id="headersContainer">`;
  for (let i = 0; i < STATE.extraHeaders.length; i++) {
    html += renderKvRow('header', i);
  }
  html += `</div>`;
  html += `<button class="btn-add" onclick="addKvRow('header')">+ ADD HEADER</button>`;

  if (ep.has_request_body) {
    html += `<div class="sec-title">REQUEST BODY</div>
      <textarea class="body-textarea" id="bodyTextarea"
        onblur="formatBody()">${esc(STATE.requestBody)}</textarea>`;
  }

  document.getElementById('reqBody').innerHTML = html;
}

function renderKvRow(type, idx) {
  const arr = type === 'query' ? STATE.queryParams : STATE.extraHeaders;
  const item = arr[idx] || { key:'', value:'', enabled:true };
  return `<div class="kv-row" id="${type}-row-${idx}">
    <input type="checkbox" class="kv-checkbox" ${item.enabled?'checked':''}
           onchange="${type==='query'?'STATE.queryParams':'STATE.extraHeaders'}[${idx}].enabled=this.checked">
    <input class="kv-input" placeholder="key" value="${esc(item.key)}"
           oninput="${type==='query'?'STATE.queryParams':'STATE.extraHeaders'}[${idx}].key=this.value">
    <input class="kv-input" placeholder="value" value="${esc(item.value)}"
           oninput="${type==='query'?'STATE.queryParams':'STATE.extraHeaders'}[${idx}].value=this.value">
    <button class="btn-remove" onclick="removeKvRow('${type}',${idx})">✕</button>
  </div>`;
}

function addKvRow(type) {
  if (type === 'query') STATE.queryParams.push({ key:'', value:'', enabled:true });
  else STATE.extraHeaders.push({ key:'', value:'', enabled:true });
  const container = document.getElementById(type === 'query' ? 'queryParamsContainer' : 'headersContainer');
  if (!container) return;
  const idx = (type === 'query' ? STATE.queryParams : STATE.extraHeaders).length - 1;
  container.insertAdjacentHTML('beforeend', renderKvRow(type, idx));
}

function removeKvRow(type, idx) {
  if (type === 'query') STATE.queryParams.splice(idx, 1);
  else STATE.extraHeaders.splice(idx, 1);
  // Re-render the builder
  if (STATE.activeEndpoint) renderRequestBuilder(STATE.activeEndpoint);
}

function formatBody() {
  const ta = document.getElementById('bodyTextarea');
  if (!ta) return;
  const val = ta.value.trim();
  STATE.requestBody = val;
  if (!val) return;
  try {
    ta.value = JSON.stringify(JSON.parse(val), null, 2);
    STATE.requestBody = ta.value;
  } catch (_) {}
}

/* ══════════════════════════════════════════
   EXECUTE REQUEST
══════════════════════════════════════════ */
async function executeRequest() {
  if (STATE.requestInFlight || !STATE.activeEndpoint) return;
  const envId = document.getElementById('envSelect').value || STATE.activeEnvId;
  if (!envId) {
    alert('Please select an environment first.');
    return;
  }

  STATE.requestInFlight = true;
  const btn = document.getElementById('execBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  const ep = STATE.activeEndpoint;

  // Collect path params from inputs
  document.querySelectorAll('[oninput^="STATE.pathParams"]').forEach(el => {
    const match = el.getAttribute('oninput').match(/\['(.+?)'\]/);
    if (match) STATE.pathParams[match[1]] = el.value;
  });

  // Body
  const bodyTA = document.getElementById('bodyTextarea');
  if (bodyTA) STATE.requestBody = bodyTA.value;

  let body = null;
  if (ep.has_request_body && STATE.requestBody.trim()) {
    try { body = JSON.parse(STATE.requestBody); } catch (_) { body = STATE.requestBody; }
  }

  const queryParams = {};
  for (const q of STATE.queryParams) {
    if (q.enabled && q.key) queryParams[q.key] = q.value;
  }
  const headers = {};
  for (const h of STATE.extraHeaders) {
    if (h.enabled && h.key) headers[h.key] = h.value;
  }

  const payload = {
    environment_id: envId,
    method: ep.method,
    path: ep.path,
    path_params: STATE.pathParams,
    query_params: queryParams,
    headers,
    body,
    timeout: 30.0,
  };

  try {
    const resp = await fetch('/api/proxy/execute', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    if (resp.status === 404) {
      const err = await resp.json();
      renderResponseError('404 — ' + (err.detail || 'Not found'));
    } else if (resp.status === 502) {
      const err = await resp.json();
      renderResponseError('502 — Upstream unreachable: ' + (err.detail || ''));
    } else if (resp.status === 504) {
      const err = await resp.json();
      renderResponseError('504 — Gateway timeout: ' + (err.detail || ''));
    } else {
      STATE.response = await resp.json();
      renderResponse(STATE.response);
    }
  } catch (e) {
    renderResponseError('Network error: ' + e.message);
  } finally {
    STATE.requestInFlight = false;
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

/* ══════════════════════════════════════════
   RESPONSE RENDERING
══════════════════════════════════════════ */
function renderResponseEmpty() {
  document.getElementById('respBody').innerHTML =
    '<div class="resp-empty">Execute a request to see the response.</div>';
  document.getElementById('respMeta').innerHTML = '';
}

function renderResponseError(msg) {
  document.getElementById('respMeta').innerHTML =
    `<span class="status-badge s-5xx">ERROR</span>`;
  document.getElementById('respBody').innerHTML =
    `<div class="error-msg">${esc(msg)}</div>`;
}

function renderResponse(resp) {
  const sc = resp.status_code;
  const scClass = statusClass(sc);

  document.getElementById('respMeta').innerHTML = `
    <span class="status-badge ${scClass}">${sc}</span>
    <span class="resp-time">${resp.duration_ms} ms</span>
    <span class="resp-url" title="${esc(resp.url)}">${esc(resp.url)}</span>
  `;

  renderRespTab('body');
}

let activeRespTab = 'body';

function renderRespTab(tab) {
  activeRespTab = tab;
  const resp = STATE.response;
  if (!resp) return;

  const meta = document.getElementById('respBody');

  const tabs = `<div class="resp-tabs">
    <button class="resp-tab ${tab==='body'?'active':''}" onclick="renderRespTab('body')">BODY</button>
    <button class="resp-tab ${tab==='headers'?'active':''}" onclick="renderRespTab('headers')">HEADERS</button>
  </div><div class="resp-content" id="respContent"></div>`;

  meta.innerHTML = tabs;

  const content = document.getElementById('respContent');
  if (tab === 'body') {
    const bodyStr = typeof resp.body === 'string' ? resp.body : JSON.stringify(resp.body, null, 2);
    content.innerHTML = `<pre class="resp-body-pre">${jfmt(resp.body)}</pre>`;
  } else {
    let rows = '';
    for (const [k, v] of Object.entries(resp.headers || {})) {
      rows += `<tr><td class="hdr-key">${esc(k)}</td><td class="hdr-val">${esc(v)}</td></tr>`;
    }
    content.innerHTML = `<table class="hdr-table">
      <thead><tr><th>HEADER</th><th>VALUE</th></tr></thead>
      <tbody>${rows}</tbody></table>`;
  }
}

/* ══════════════════════════════════════════
   MODALS
══════════════════════════════════════════ */
function openSpecModal() {
  document.getElementById('specModal').classList.add('open');
  renderEnvSelect();
  document.getElementById('specMsg').innerHTML = '';
}
function closeSpecModal() {
  document.getElementById('specModal').classList.remove('open');
}
function openEnvModal() {
  document.getElementById('envModal').classList.add('open');
  resetEnvForm();
}
function closeEnvModal() {
  document.getElementById('envModal').classList.remove('open');
}

// Close modal on overlay click
document.getElementById('specModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeSpecModal();
});
document.getElementById('envModal').addEventListener('click', e => {
  if (e.target === e.currentTarget) closeEnvModal();
});

/* ══════════════════════════════════════════
   HELPERS
══════════════════════════════════════════ */
function esc(s) {
  if (s == null) return '';
  return String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

function showMsg(id, text, type) {
  const el = document.getElementById(id);
  if (!el) return;
  el.innerHTML = `<div class="${type==='error'?'error-msg':'success-msg'}">${esc(text)}</div>`;
}

/* ══════════════════════════════════════════
   INIT
══════════════════════════════════════════ */
async function init() {
  await loadEnvironments();
  await loadExistingSpec();
}

init();
</script>
</body>
</html>
